<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Sweet Shop</title>
    <link rel="stylesheet" href="style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Droid+Sans&display=swap" rel="stylesheet">
</head>
<body>
    <header class="navbar">
    <div class="nav-left">
        <div class="logo">
            <a href="./">
                <img src="/assets/logo.png" alt="The Sweet Shop Logo" class="logo-img" />
            </a>
        </div>
    <div class="profile-icon">
        <a href="signup.html">
            <i data-lucide="user-circle"></i>
        </a>
    </div>
    <div class="add-product-icon">
        <a href="addProduct.html">
            <i data-lucide="plus-circle"></i>
        </a>
    </div>
    <div class="nav-links">
        <div class="categories-wrap">
            <a href="#" class="categories-tab" id="toggle-panel">Categories</a>
            <div class="side-panel" id="side-panel">
                <a href="search.html?category=GUMMIES" style="color: white;">Gummies</a>
                <a href="search.html?category=CHOCOLATE" style="color: white;">Chocolate</a>
                <a href="search.html?category=OTHER" style="color: white;">Other</a>
                <a href="search.html" style="color: white;">All</a>
            </div>
        </div>
        <a href="#">Best Sellers</a>
        <a href="#">New</a>
    </div>
</div>
<div class="nav-right">
    <div class="search-bar">
        <input id="searchInput" type="text" placeholder="Search..." />
        <i data-lucide="search" id="searchIcon" style="color: white; margin-left: 1px;"></i>
      </div>
      <div class="cart-wrap">
        <i data-lucide="shopping-cart" class="icon-cart"></i>
      </div>
    </div>
  </header>
<main id="out"></main>
<script>
  const params = Object.fromEntries(new URLSearchParams(location.search));

  fetch('http://localhost:8080/api/reports?' + new URLSearchParams(params))
    .then(r => r.ok ? r.json() : Promise.reject(r))
    .then(data => renderCards(data))
    .catch(err => {
      document.getElementById('out').innerHTML = `
        <div class="error-card">Error loading report :)</div>
      `;
    });

  function fmtPrice(val) {
    const n = Number(val);
    return Number.isFinite(n) ? `$${n.toFixed(2)}` : (val ?? '');
  }
  function esc(s) {
    return String(s ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function renderCards(rows) {
  const out = document.getElementById('out');
  if (!Array.isArray(rows) || rows.length === 0) {
    out.innerHTML = '<div class="results-card">No results</div>';
    return;
  }

  const sample = rows[0] ?? {};
  const type = sample.hasOwnProperty('productName')
    ? 'product'
    : sample.hasOwnProperty('username')
    ? 'user'
    : 'generic';

  const fmtPrice = (v) => {
    const n = Number(v);
    return Number.isFinite(n) ? `$${n.toFixed(2)}` : (v ?? '');
  };

  const html = rows.map((item) => {
    if (type === 'product') {
      const p = item;
      return `
        <article class="product-card">
          <h3 class="card-title">${esc(p.productName)}</h3>
          ${p.category ? `<span class="badge">${esc(p.category)}</span>` : ''}
          ${p.description ? `<p class="card-desc">${esc(p.description)}</p>` : ''}
          <div class="card-meta">
            ${p.price !== undefined ? `<span class="price">${fmtPrice(p.price)}</span>` : ''}
            ${p.stockQuantity !== undefined ? `<span class="stock">Stock: ${esc(p.stockQuantity)}</span>` : ''}
          </div>
          <div class="card-foot">
            ${p.addedByUsername ? `<span class="adder">by ${esc(p.addedByUsername)}</span>` : ''}
            ${p.dateAdded ? `<time datetime="${esc(p.dateAdded)}">${esc(p.dateAdded)}</time>` : ''}
          </div>
        </article>
      `;
    }

    if (type === 'user') {
      const u = item;
      return `
        <article class="user-card">
          <h3 class="user-name">${esc(u.username)}</h3>
          ${u.email ? `<p class="user-email">${esc(u.email)}</p>` : ''}
          ${u.role ? `<span class="user-role">${esc(u.role)}</span>` : ''}
          ${u.dateCreated ? `<time datetime="${esc(u.dateCreated)}">Joined: ${esc(u.dateCreated)}</time>` : ''}
        </article>
      `;
    }

    // fallback: generic key:value dump
    return `
      <article class="generic-card">
        ${Object.entries(item)
          .map(([k, v]) => `<p><b>${esc(k)}:</b> ${esc(v)}</p>`)
          .join('')}
      </article>
    `;
  }).join('');

  out.innerHTML = `<section class="cards-grid">${html}</section>`;
}
</script>

<script type="module">
  import { createIcons, icons } from 'https://unpkg.com/lucide@latest/dist/esm/lucide.js';
  createIcons({ icons });
</script>

<style>
  table{width:100%;border-collapse:collapse;color:#fff}
  th,td{border:1px solid rgba(255,255,255,.2);padding:8px 10px;text-align:left}
  th{background:rgba(255,255,255,.08)}
</style>
</body>
</html>
